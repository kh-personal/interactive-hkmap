<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>香港商業地圖門戶 (HK Business Map Portal)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #root { height: 100%; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Map Container */
        .leaflet-container { height: 100%; width: 100%; z-index: 1; }

        /* Marker Labels */
        .marker-label {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            margin-top: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
            pointer-events: none;
            text-align: center;
        }

        /* Custom Pulse Animation for Client Circles */
        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 0.8; }
            80%, 100% { opacity: 0; }
        }
        .pulse-marker {
            background: rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            height: 100%;
            width: 100%;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Mock Data Generators (For users who don't have JSON ready immediately) ---
        const generateSampleClinics = () => [
            { name: "Central Medical Hub", code: "C001", address: "1 Queen's Road Central, Hong Kong", tier: "Gold" },
            { name: "Mong Kok Health", code: "C002", address: "Argyle Street, Mong Kok, Kowloon", tier: "Silver" },
            { name: "Shatin Family Clinic", code: "C003", address: "New Town Plaza, Shatin, NT", tier: "Bronze" },
            { name: "Tuen Mun Care", code: "C004", address: "Tuen Mun Town Plaza, NT", tier: "Silver" },
            { name: "Kwun Tong Physio", code: "C005", address: "apm, Kwun Tong, Kowloon", tier: "Gold" }
        ];

        const generateSampleClients = () => [
            { no: "CL001", name: "Big Corp Finance", address: "IFC, Central, Hong Kong", employee_count: 500 },
            { no: "CL002", name: "Tech Startup HK", address: "Science Park, Shatin, NT", employee_count: 50 },
            { no: "CL003", name: "Logistics Co", address: "Kwai Chung Container Terminal, NT", employee_count: 1200 },
            { no: "CL004", name: "Retail Chain HQ", address: "Causeway Bay, Hong Kong", employee_count: 150 },
            { no: "CL005", name: "Design Studio", address: "Lai Chi Kok, Kowloon", employee_count: 20 }
        ];

        // --- Helper: Pseudo Geocoding (Simulated) ---
        // In a real app, this would call Google Maps API.
        // Here, we map common district keywords to coordinates to make the demo work immediately.
        const DISTRICT_COORDS = {
            "central": [22.2819, 114.1581, "HK"],
            "admiralty": [22.2796, 114.1655, "HK"],
            "wan chai": [22.2760, 114.1751, "HK"],
            "causeway bay": [22.2800, 114.1850, "HK"],
            "north point": [22.2922, 114.1990, "HK"],
            "mong kok": [22.3193, 114.1694, "KLN"],
            "tsim sha tsui": [22.2988, 114.1722, "KLN"],
            "jordan": [22.3040, 114.1710, "KLN"],
            "kwun tong": [22.3104, 114.2225, "KLN"],
            "lai chi kok": [22.3364, 114.1476, "KLN"],
            "shatin": [22.3820, 114.1920, "NT"],
            "sha tin": [22.3820, 114.1920, "NT"],
            "tai po": [22.4508, 114.1642, "NT"],
            "tuen mun": [22.3916, 113.9760, "NT"],
            "yuen long": [22.4456, 114.0222, "NT"],
            "tsuen wan": [22.3700, 114.1130, "NT"],
            "kwai chung": [22.3600, 114.1300, "NT"],
            "science park": [22.4285, 114.2090, "NT"]
        };

        const getRegionFromAddress = (address) => {
            const lowerAddr = address.toLowerCase();
            if (lowerAddr.includes("hong kong") || lowerAddr.includes("hk")) return "HK";
            if (lowerAddr.includes("kowloon") || lowerAddr.includes("kln")) return "KLN";
            if (lowerAddr.includes("new territories") || lowerAddr.includes("nt")) return "NT";
            
            // Fallback by district
            for (const [key, val] of Object.entries(DISTRICT_COORDS)) {
                if (lowerAddr.includes(key)) return val[2];
            }
            return "Unknown";
        };

        const pseudoGeocode = (address) => {
            const lowerAddr = address.toLowerCase();
            let baseCoords = [22.3193, 114.1694]; // Default Center (Mong Kok-ish)
            let region = getRegionFromAddress(address);

            let found = false;
            for (const [key, coords] of Object.entries(DISTRICT_COORDS)) {
                if (lowerAddr.includes(key)) {
                    baseCoords = [coords[0], coords[1]];
                    region = coords[2];
                    found = true;
                    break;
                }
            }

            // Add small random jitter so points don't stack exactly on top of each other
            const jitter = 0.003; 
            return {
                lat: baseCoords[0] + (Math.random() - 0.5) * jitter,
                lng: baseCoords[1] + (Math.random() - 0.5) * jitter,
                region: region
            };
        };

        // --- Icons ---
        const Icons = {
            Upload: () => <i data-lucide="upload-cloud"></i>,
            Filter: () => <i data-lucide="filter"></i>,
            Map: () => <i data-lucide="map"></i>,
            Clinic: () => <i data-lucide="stethoscope"></i>,
            Client: () => <i data-lucide="users"></i>,
            Info: () => <i data-lucide="info"></i>
        };

        // --- Main App Component ---
        const App = () => {
            // State
            const [clinics, setClinics] = useState([]);
            const [clients, setClients] = useState([]);
            const [mapInstance, setMapInstance] = useState(null);
            const [layerGroups, setLayerGroups] = useState({ clinics: null, clients: null });
            const [zoomLevel, setZoomLevel] = useState(11); // Track zoom level
            
            // Filters
            const [filters, setFilters] = useState({
                minEmployees: 0,
                maxEmployees: 10000,
                regions: { HK: true, KLN: true, NT: true, Unknown: true },
                tiers: { Gold: true, Silver: true, Bronze: true, Other: true }
            });

            const mapRef = useRef(null);

            // Initialize Icons
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, []);

            // Initialize Map
            useEffect(() => {
                if (!mapRef.current) return;
                
                // Initialize Leaflet Map
                const map = L.map(mapRef.current).setView([22.3193, 114.1694], 11);

                // Add Tile Layer (CartoDB Positron for clean look)
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                }).addTo(map);

                const clinicLayer = L.layerGroup().addTo(map);
                const clientLayer = L.layerGroup().addTo(map);

                setMapInstance(map);
                setLayerGroups({ clinics: clinicLayer, clients: clientLayer });

                // Event Listener for Zoom
                map.on('zoomend', () => {
                    setZoomLevel(map.getZoom());
                });

                return () => {
                    map.remove();
                };
            }, []);

            // Handle File Uploads
            const handleFileUpload = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const rawData = JSON.parse(event.target.result);
                        
                        // Process data with pseudo-geocoding
                        const processedData = rawData.map(item => {
                            const location = pseudoGeocode(item.address || item.clinic_address || item.client_address || "");
                            return { ...item, ...location };
                        });

                        if (type === 'clinics') setClinics(processedData);
                        if (type === 'clients') setClients(processedData);

                    } catch (error) {
                        alert("Error parsing JSON: " + error.message);
                    }
                };
                reader.readAsText(file);
            };

            // Load Sample Data
            const loadSamples = () => {
                const sampleClinics = generateSampleClinics().map(item => ({...item, ...pseudoGeocode(item.address)}));
                const sampleClients = generateSampleClients().map(item => ({...item, ...pseudoGeocode(item.address)}));
                setClinics(sampleClinics);
                setClients(sampleClients);
            };

            // Update Map Markers based on Data & Filters
            useEffect(() => {
                if (!mapInstance || !layerGroups.clinics || !layerGroups.clients) return;

                // Clear existing layers
                layerGroups.clinics.clearLayers();
                layerGroups.clients.clearLayers();

                // Threshold for showing detailed labels
                const showDetails = zoomLevel >= 14;

                // --- Render Clinics ---
                clinics.forEach(clinic => {
                    // Filter Logic
                    const tier = clinic.tier || "Other";
                    const showTier = filters.tiers[tier] !== false && (tier in filters.tiers ? filters.tiers[tier] : filters.tiers.Other);
                    const showRegion = filters.regions[clinic.region];

                    if (!showTier || !showRegion) return;

                    // Color Coding
                    let color = "#3b82f6"; // Blue (Default)
                    if (tier === "Gold") color = "#eab308";
                    if (tier === "Silver") color = "#94a3b8";
                    if (tier === "Bronze") color = "#b45309";

                    const code = clinic.code || clinic.clinic_code || "?";
                    const name = clinic.name || clinic.clinic_name || "Unknown Clinic";

                    // Dynamic HTML for Marker
                    const markerHtml = `
                        <div style="position: relative; width: 32px; height: 32px;">
                            <div style="
                                background-color: ${color}; 
                                width: 32px; height: 32px; 
                                border-radius: 50%; 
                                border: 2px solid white; 
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3); 
                                display: flex; align-items: center; justify-content: center; 
                                color: white; font-weight: bold; font-size: 10px;
                                overflow: hidden; white-space: nowrap;
                            ">
                               ${code}
                            </div>
                            ${showDetails ? `
                                <div class="marker-label text-gray-800">
                                    ${name}
                                </div>
                            ` : ''}
                        </div>
                    `;

                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: markerHtml,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16] // Center the icon
                    });

                    L.marker([clinic.lat, clinic.lng], { icon })
                        .bindPopup(`
                            <div class="font-sans">
                                <h3 class="font-bold text-lg border-b pb-1 mb-2">${name}</h3>
                                <p><strong>Code:</strong> ${code}</p>
                                <p><strong>Tier:</strong> <span style="color:${color}">${tier}</span></p>
                                <p class="text-sm text-gray-500 mt-2">${clinic.address || clinic.clinic_address}</p>
                            </div>
                        `)
                        .addTo(layerGroups.clinics);
                });

                // --- Render Clients ---
                clients.forEach(client => {
                    // Filter Logic
                    const employees = parseInt(client.employee_count || client.no_of_employee || 0);
                    if (employees < filters.minEmployees || employees > filters.maxEmployees) return;
                    if (!filters.regions[client.region]) return;

                    // Size calculation (Pixel based now, instead of Meters)
                    // Log scale to prevent huge bubbles, min size 30px
                    const size = Math.max(36, Math.min(80, Math.log(employees + 1) * 12)); 
                    const clientNo = client.no || client.client_no || "?";
                    const clientName = client.name || client.client_name || "Unknown Client";
                    
                    // Render Client as a DivIcon to allow text inside
                    const clientHtml = `
                        <div style="position: relative; width: ${size}px; height: ${size}px;">
                            <div style="
                                background-color: rgba(239, 68, 68, 0.8); 
                                width: 100%; height: 100%; 
                                border-radius: 50%; 
                                border: 1px solid white; 
                                display: flex; align-items: center; justify-content: center; 
                                color: white; font-weight: bold; font-size: ${size > 50 ? '12px' : '10px'};
                                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                            ">
                                ${employees}
                            </div>
                            ${showDetails ? `
                                <div class="marker-label text-gray-800">
                                    <div class="font-bold text-blue-800">${clientNo}</div>
                                    <div>${clientName}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;

                    const icon = L.divIcon({
                        className: 'custom-client-icon',
                        html: clientHtml,
                        iconSize: [size, size],
                        iconAnchor: [size / 2, size / 2] // Center the circle
                    });
                    
                    L.marker([client.lat, client.lng], { icon })
                    .bindPopup(`
                        <div class="font-sans">
                            <h3 class="font-bold text-lg border-b pb-1 mb-2">${clientName}</h3>
                            <p><strong>Client No:</strong> ${clientNo}</p>
                            <p><strong>Employees:</strong> ${employees}</p>
                            <p class="text-sm text-gray-500 mt-2">${client.address || client.client_address}</p>
                        </div>
                    `)
                    .addTo(layerGroups.clients);
                });

            }, [clinics, clients, filters, mapInstance, zoomLevel]); // Re-render when zoom changes

            // Filter Handlers
            const toggleRegion = (region) => {
                setFilters(prev => ({ ...prev, regions: { ...prev.regions, [region]: !prev.regions[region] } }));
            };
            
            const toggleTier = (tier) => {
                setFilters(prev => ({ ...prev, tiers: { ...prev.tiers, [tier]: !prev.tiers[tier] } }));
            };

            return (
                <div className="flex flex-col md:flex-row h-full">
                    
                    {/* Sidebar / Control Panel */}
                    <div className="w-full md:w-96 bg-white border-r border-gray-200 flex flex-col h-1/3 md:h-full overflow-y-auto shadow-xl z-20">
                        <div className="p-6 border-b border-gray-100 bg-slate-50">
                            <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="map" className="w-6 h-6 text-blue-600"></i>
                                HK Data Map
                            </h1>
                            <p className="text-sm text-gray-500 mt-1">Interactive Business Intelligence</p>
                        </div>

                        <div className="p-6 space-y-8">
                            
                            {/* Data Upload Section */}
                            <div className="space-y-4">
                                <h2 className="text-sm font-semibold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                                    <i data-lucide="upload-cloud" className="w-4 h-4"></i> Data Import
                                </h2>
                                
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Clinics JSON List</label>
                                        <input 
                                            type="file" 
                                            accept=".json"
                                            onChange={(e) => handleFileUpload(e, 'clinics')}
                                            className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors"
                                        />
                                        <div className="text-xs text-gray-400 mt-1 flex justify-between">
                                            <span>{clinics.length} loaded</span>
                                            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span> Clinic</span>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">Clients JSON List</label>
                                        <input 
                                            type="file" 
                                            accept=".json"
                                            onChange={(e) => handleFileUpload(e, 'clients')}
                                            className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100 transition-colors"
                                        />
                                        <div className="text-xs text-gray-400 mt-1 flex justify-between">
                                            <span>{clients.length} loaded</span>
                                            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-400"></span> Client</span>
                                        </div>
                                    </div>

                                    <button 
                                        onClick={loadSamples}
                                        className="w-full py-2 px-4 bg-gray-100 text-gray-600 text-xs font-medium rounded hover:bg-gray-200 transition-colors dashed border border-gray-300"
                                    >
                                        Use Sample Data (Demo)
                                    </button>
                                </div>
                            </div>

                            <hr className="border-gray-100" />

                            {/* Filters Section */}
                            <div className="space-y-4">
                                <h2 className="text-sm font-semibold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                                    <i data-lucide="filter" className="w-4 h-4"></i> Filters
                                </h2>

                                {/* Region Filter */}
                                <div>
                                    <label className="text-xs font-medium text-gray-700 block mb-2">Regions</label>
                                    <div className="flex gap-2">
                                        {['HK', 'KLN', 'NT'].map(r => (
                                            <button 
                                                key={r}
                                                onClick={() => toggleRegion(r)}
                                                className={`flex-1 py-1 text-xs rounded border transition-all ${
                                                    filters.regions[r] 
                                                    ? 'bg-slate-700 text-white border-slate-700' 
                                                    : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'
                                                }`}
                                            >
                                                {r}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Clinic Tier Filter */}
                                <div>
                                    <label className="text-xs font-medium text-gray-700 block mb-2">Clinic Tier</label>
                                    <div className="space-y-2">
                                        {['Gold', 'Silver', 'Bronze'].map(t => (
                                            <label key={t} className="flex items-center text-sm text-gray-600 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                                <input 
                                                    type="checkbox" 
                                                    checked={filters.tiers[t]} 
                                                    onChange={() => toggleTier(t)}
                                                    className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3"
                                                />
                                                <span className={`w-2 h-2 rounded-full mr-2 ${
                                                    t === 'Gold' ? 'bg-yellow-500' : t === 'Silver' ? 'bg-slate-400' : 'bg-amber-700'
                                                }`}></span>
                                                {t} Tier
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                {/* Employee Count Filter */}
                                <div>
                                    <label className="text-xs font-medium text-gray-700 block mb-2">
                                        Client Size (Employees): {filters.minEmployees} +
                                    </label>
                                    <input 
                                        type="range" 
                                        min="0" 
                                        max="2000" 
                                        step="50"
                                        value={filters.minEmployees}
                                        onChange={(e) => setFilters({...filters, minEmployees: parseInt(e.target.value)})}
                                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                    />
                                    <div className="flex justify-between text-xs text-gray-400 mt-1">
                                        <span>0</span>
                                        <span>2000+</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Map Area */}
                    <div className="flex-1 h-2/3 md:h-full relative">
                        <div ref={mapRef} className="w-full h-full z-10"></div>
                        
                        {/* Map Legend Overlay */}
                        <div className="absolute bottom-6 right-6 bg-white/90 backdrop-blur p-4 rounded-lg shadow-lg z-[500] text-xs pointer-events-none">
                            <h4 className="font-bold mb-2 text-gray-700">Legend</h4>
                            <div className="space-y-2">
                                <div className="flex items-center gap-2">
                                    <span className="w-3 h-3 rounded-full bg-yellow-500 border border-white shadow"></span>
                                    <span>Clinic (Gold)</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="w-3 h-3 rounded-full bg-slate-400 border border-white shadow"></span>
                                    <span>Clinic (Silver)</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span className="w-3 h-3 rounded-full bg-red-400 opacity-50"></span>
                                    <span>Client (Size = Staff)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>